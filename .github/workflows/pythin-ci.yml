name: Python - Tests + Coverage + Pylint

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTEST_MAXFAIL: "1"
  PYTEST_COV_TARGET: "."
  PYLINT_FAIL_ON_ISSUES: "true"   # "false" => pylint advisory only
  PYLINT_MIN_SCORE: ""            # e.g. "9.0" to enforce; "" disables score gate

jobs:
  test-and-coverage:
    name: pytest (py${{ matrix.python-version }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Install dependencies (generic)
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip setuptools wheel

          if [ -f requirements.txt ]; then python -m pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then python -m pip install -r requirements-dev.txt; fi

          if [ -f pyproject.toml ]; then
            python -m pip install -e ".[dev]" || python -m pip install -e "."
          fi

          python -m pip install pytest pytest-cov coverage

          python -V
          python -m pip -V
          python -m pip check || true

      - name: Run pytest with coverage (XML + terminal)
        shell: bash
        env:
          PYTHONWARNINGS: "default"
        run: |
          set -euo pipefail
          pytest -q \
            --disable-warnings \
            --maxfail="${PYTEST_MAXFAIL}" \
            --cov="${PYTEST_COV_TARGET}" \
            --cov-report=term-missing \
            --cov-report=xml:coverage.xml

      - name: Generate HTML coverage report
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          python -m coverage html -d htmlcov

      - name: Upload coverage.xml artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml-py${{ matrix.python-version }}
          path: coverage.xml
          if-no-files-found: warn

      - name: Upload HTML coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html-py${{ matrix.python-version }}
          path: htmlcov
          if-no-files-found: warn

  pylint:
    name: pylint (py3.11)
    runs-on: ubuntu-latest
    needs: test-and-coverage

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies for linting (generic)
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip setuptools wheel

          if [ -f requirements.txt ]; then python -m pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then python -m pip install -r requirements-dev.txt; fi

          if [ -f pyproject.toml ]; then
            python -m pip install -e ".[all,dev]" || python -m pip install -e ".[dev]" || python -m pip install -e "."
          fi

          python -m pip install pylint

          python -V
          python -m pip -V
          python -m pip check || true

      - name: Run pylint (tracked files)
        shell: bash
        env:
          PYLINT_MIN_SCORE: ${{ env.PYLINT_MIN_SCORE }}
          PYLINT_FAIL_ON_ISSUES: ${{ env.PYLINT_FAIL_ON_ISSUES }}
        run: |
          set -euo pipefail

          git ls-files -z -- '*.py' > /tmp/pylint-files.bin || true
          if [ ! -s /tmp/pylint-files.bin ]; then
            echo "No tracked Python files found; skipping pylint."
            exit 0
          fi

          set +e
          OUTPUT="$(tr '\0' '\n' < /tmp/pylint-files.bin | xargs -r python -m pylint 2>&1)"
          STATUS="$?"
          set -e

          echo "${OUTPUT}"

          if [ -n "${PYLINT_MIN_SCORE}" ]; then
            SCORE="$(printf "%s\n" "${OUTPUT}" | sed -n "s/Your code has been rated at \([0-9.]\+\)\/10.*/\1/p" | tail -n 1)"
            if [ -n "${SCORE}" ]; then
              python -c "import os,sys; score=float(os.environ.get('SCORE','0')); min_score=float(os.environ.get('PYLINT_MIN_SCORE','0')); print(f'Pylint score: {score}/10 (min {min_score})'); sys.exit(1 if score < min_score else 0)" \
                SCORE="${SCORE}" PYLINT_MIN_SCORE="${PYLINT_MIN_SCORE}"
            else
              echo "Warning: could not parse pylint score; skipping score gate."
            fi
          fi

          if [ "${PYLINT_FAIL_ON_ISSUES}" = "true" ]; then
            exit "${STATUS}"
          fi

          echo "PYLINT_FAIL_ON_ISSUES=false -> not failing the job (pylint exit code was ${STATUS})"
          exit 0
